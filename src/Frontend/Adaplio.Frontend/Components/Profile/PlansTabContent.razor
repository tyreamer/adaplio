@using Adaplio.Frontend.Services
@inject AuthStateService AuthState

<div class="plans-content">
    @if (!Plans.Any())
    {
        <div class="empty-plans">
            <div class="empty-state-icon">
                <MudIcon Icon="@Icons.Material.Outlined.Assignment" Size="Size.Large" />
            </div>
            <h3 class="empty-state-title">No Plans Assigned</h3>
            <p class="empty-state-description">
                @if (AuthState.IsClient)
                {
                    <text>Your trainer hasn't assigned a plan yet. Once they do, it will appear here.</text>
                }
                else
                {
                    <text>You haven't created any training plans yet. Start by creating your first plan.</text>
                }
            </p>
            @if (AuthState.IsTrainer)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
                    Create Plan
                </MudButton>
            }
        </div>
    }
    else
    {
        <div class="plans-header">
            <div class="plans-title">
                <h2>@(AuthState.IsClient ? "Your Plans" : "Training Plans")</h2>
                <p>@($"{Plans.Count} plan{(Plans.Count == 1 ? "" : "s")} â€¢ {Plans.Count(p => p.Status == "Active")} active")</p>
            </div>
            @if (AuthState.IsTrainer)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
                    New Plan
                </MudButton>
            }
        </div>

        <div class="plans-grid">
            @foreach (var plan in Plans)
            {
                <div class="plan-card @GetPlanStatusClass(plan.Status)" @onclick="@(() => OpenPlan(plan))">
                    <div class="plan-header">
                        <div class="plan-status-badge @plan.Status.ToLower()">
                            <MudIcon Icon="@GetStatusIcon(plan.Status)" Size="Size.Small" />
                            @plan.Status
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                       Size="Size.Small"
                                       Class="plan-menu"
                                       @onclick:stopPropagation="true" />
                    </div>

                    <div class="plan-content">
                        <h3 class="plan-title">@plan.Name</h3>
                        <p class="plan-description">@plan.Description</p>

                        <div class="plan-dates">
                            <div class="date-item">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                @plan.StartDate.ToString("MMM dd") - @plan.EndDate.ToString("MMM dd, yyyy")
                            </div>
                            <div class="duration-item">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                @GetPlanDuration(plan) weeks
                            </div>
                        </div>

                        <div class="plan-progress">
                            <div class="progress-header">
                                <span class="progress-label">Progress</span>
                                <span class="progress-percentage">@plan.CompletionPercentage%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: @(plan.CompletionPercentage)%"></div>
                            </div>
                        </div>

                        @if (plan.Status == "Active")
                        {
                            <div class="plan-stats">
                                <div class="stat-item">
                                    <span class="stat-value">@plan.CompletedExercises</span>
                                    <span class="stat-label">Completed</span>
                                </div>
                                <div class="stat-divider"></div>
                                <div class="stat-item">
                                    <span class="stat-value">@plan.TotalExercises</span>
                                    <span class="stat-label">Total</span>
                                </div>
                                <div class="stat-divider"></div>
                                <div class="stat-item">
                                    <span class="stat-value">@GetDaysRemaining(plan)</span>
                                    <span class="stat-label">Days left</span>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="plan-footer">
                        @if (plan.Status == "Active")
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true">
                                Continue Plan
                            </MudButton>
                        }
                        else if (plan.Status == "Completed")
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true">
                                View Results
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true">
                                View Details
                            </MudButton>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<PlanItem> Plans = new()
    {
        new()
        {
            Id = 1,
            Name = "Hip Flexor Recovery Protocol",
            Description = "Comprehensive 6-week program focusing on hip flexor mobility and strength.",
            Status = "Active",
            StartDate = DateTime.Now.AddDays(-14),
            EndDate = DateTime.Now.AddDays(28),
            CompletionPercentage = 65,
            CompletedExercises = 18,
            TotalExercises = 28
        },
        new()
        {
            Id = 2,
            Name = "Core Strengthening Phase 1",
            Description = "Foundation exercises to build core stability and prevent future injuries.",
            Status = "Completed",
            StartDate = DateTime.Now.AddDays(-56),
            EndDate = DateTime.Now.AddDays(-14),
            CompletionPercentage = 100,
            CompletedExercises = 24,
            TotalExercises = 24
        },
        new()
        {
            Id = 3,
            Name = "Advanced Mobility Protocol",
            Description = "Next phase focusing on dynamic movement patterns and functional strength.",
            Status = "Pending",
            StartDate = DateTime.Now.AddDays(30),
            EndDate = DateTime.Now.AddDays(72),
            CompletionPercentage = 0,
            CompletedExercises = 0,
            TotalExercises = 32
        }
    };

    private string GetPlanStatusClass(string status)
    {
        return status.ToLower();
    }

    private string GetStatusIcon(string status)
    {
        return status switch
        {
            "Active" => Icons.Material.Filled.PlayArrow,
            "Completed" => Icons.Material.Filled.CheckCircle,
            "Pending" => Icons.Material.Filled.Schedule,
            _ => Icons.Material.Filled.Circle
        };
    }

    private int GetPlanDuration(PlanItem plan)
    {
        return (int)Math.Ceiling((plan.EndDate - plan.StartDate).TotalDays / 7.0);
    }

    private int GetDaysRemaining(PlanItem plan)
    {
        return Math.Max(0, (int)(plan.EndDate - DateTime.Now).TotalDays);
    }

    private void OpenPlan(PlanItem plan)
    {
        // Handle plan opening
    }

    public class PlanItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Status { get; set; } = "";
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int CompletionPercentage { get; set; }
        public int CompletedExercises { get; set; }
        public int TotalExercises { get; set; }
    }
}