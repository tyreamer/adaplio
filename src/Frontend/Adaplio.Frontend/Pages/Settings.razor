@page "/settings"
@using Adaplio.Frontend.Services
@using System.ComponentModel.DataAnnotations
@inject AuthStateService AuthState
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Settings - Adaplio</PageTitle>

<RoleGate ClientOnly="true">
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
        <MudStack Spacing="6">
            <!-- Header -->
            <div>
                <MudText Typo="Typo.h4" Class="fw-bold mb-2">Settings</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Manage your profile and preferences
                </MudText>
            </div>

            <MudGrid>
                <MudItem xs="12" md="8" lg="6">
                    <!-- Profile Section -->
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" />
                                    <MudText Typo="Typo.h6">Profile Information</MudText>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <EditForm Model="@_profileModel" OnValidSubmit="@SaveProfile">
                                <DataAnnotationsValidator />

                                <MudStack Spacing="4">
                                    <!-- Nickname/Display Name -->
                                    <div>
                                        <MudTextField @bind-Value="_profileModel.DisplayName"
                                                      For="@(() => _profileModel.DisplayName)"
                                                      Label="Nickname"
                                                      Variant="Variant.Outlined"
                                                      Placeholder="How would you like to be called?"
                                                      HelperText="This is how your trainers will see you (optional)"
                                                      Disabled="@_isSaving" />
                                    </div>

                                    <!-- Current Alias (Read-only) -->
                                    <div>
                                        <MudTextField Value="@AuthState.Alias"
                                                      Label="System Alias"
                                                      Variant="Variant.Outlined"
                                                      ReadOnly="true"
                                                      HelperText="This is your unique system identifier" />
                                    </div>

                                    <!-- Email (Read-only) -->
                                    <div>
                                        <MudTextField Value="@AuthState.Email"
                                                      Label="Email Address"
                                                      Variant="Variant.Outlined"
                                                      ReadOnly="true"
                                                      HelperText="Contact support to change your email" />
                                    </div>

                                    <!-- Save Button -->
                                    <MudStack Row Justify="Justify.FlexEnd" Class="mt-4">
                                        <MudButton ButtonType="ButtonType.Submit"
                                                   Variant="Variant.Filled"
                                                   Color="Color.Primary"
                                                   Disabled="@_isSaving"
                                                   StartIcon="@Icons.Material.Filled.Save">
                                            @if (_isSaving)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <text>Saving...</text>
                                            }
                                            else
                                            {
                                                <text>Save Changes</text>
                                            }
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </EditForm>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" md="4" lg="6">
                    <!-- Info Panel -->
                    <MudStack Spacing="4">
                        <!-- Nickname Info -->
                        <MudCard Elevation="1">
                            <MudCardContent>
                                <MudStack Row AlignItems="AlignItems.Start" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" />
                                    <div>
                                        <MudText Typo="Typo.h6" Class="mb-2">About Nicknames</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Your nickname is a friendly name that your trainers will see.
                                            You can use your real name, a motivational phrase, or anything
                                            that helps personalize your therapy journey.
                                        </MudText>
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>

                        <!-- Examples -->
                        <MudCard Elevation="1">
                            <MudCardContent>
                                <MudStack Row AlignItems="AlignItems.Start" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Color="Color.Warning" />
                                    <div>
                                        <MudText Typo="Typo.h6" Class="mb-2">Nickname Examples</MudText>
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">"Sarah's Recovery"</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">"Getting Stronger ðŸ’ª"</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">"Back to Running"</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">"Knee Warrior"</MudText>
                                        </MudStack>
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>

                        <!-- Privacy -->
                        <MudCard Elevation="1">
                            <MudCardContent>
                                <MudStack Row AlignItems="AlignItems.Start" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Success" />
                                    <div>
                                        <MudText Typo="Typo.h6" Class="mb-2">Privacy & Security</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Your system alias (@AuthState.Alias) ensures your privacy.
                                            Only trainers you've connected with can see your nickname.
                                        </MudText>
                                    </div>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudStack>
    </MudContainer>
</RoleGate>

@code {
    private readonly ProfileModel _profileModel = new();
    private bool _isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        AuthState.OnAuthStateChanged += HandleAuthStateChanged;

        // Initialize the form with current data
        _profileModel.DisplayName = AuthState.DisplayName ?? "";
    }

    private void HandleAuthStateChanged()
    {
        _profileModel.DisplayName = AuthState.DisplayName ?? "";
        StateHasChanged();
    }

    private async Task SaveProfile()
    {
        _isSaving = true;

        try
        {
            var displayName = string.IsNullOrWhiteSpace(_profileModel.DisplayName)
                ? null
                : _profileModel.DisplayName.Trim();

            var success = await AuthState.UpdateProfileAsync(displayName);

            if (success)
            {
                Snackbar.Add("Profile updated successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update profile. Please try again.", Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("An error occurred while updating your profile.", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    public void Dispose()
    {
        AuthState.OnAuthStateChanged -= HandleAuthStateChanged;
    }

    public class ProfileModel
    {
        [MaxLength(100, ErrorMessage = "Nickname cannot exceed 100 characters")]
        public string DisplayName { get; set; } = "";
    }
}