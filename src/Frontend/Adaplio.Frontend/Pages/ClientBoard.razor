@page "/board"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Weekly Board - Adaplio</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-8">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">
            @errorMessage
        </MudAlert>
    }

    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">
            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="mr-2" />
            My Weekly Board
        </MudText>
        <div class="d-flex align-center gap-3">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                           OnClick="PreviousWeek"
                           Title="Previous Week" />
            <MudText Typo="Typo.h6" Class="mx-2">
                @currentWeekStart.ToString("MMM dd") - @currentWeekStart.AddDays(6).ToString("MMM dd, yyyy")
            </MudText>
            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                           OnClick="NextWeek"
                           Title="Next Week" />
        </div>
    </div>

    @if (isLoading)
    {
        <div class="board-loading">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Class="mt-4">Loading your weekly board...</MudText>
        </div>
    }
    else if (board != null)
    {
        <!-- 7-Column Weekly Grid -->
        <div class="weekly-board-grid">
            @foreach (var day in board.Days)
            {
                <div class="day-column @GetDayColumnClass(day.Date)">
                    <div class="day-header">
                        <MudText Typo="Typo.h6" Class="day-name">@day.DayName</MudText>
                        <MudText Typo="Typo.body2" Class="day-date">@day.Date.ToString("MMM dd")</MudText>
                        @if (day.Exercises.Any())
                        {
                            <div class="day-progress">
                                @{
                                    var dayTotal = day.Exercises.Count();
                                    var dayCompleted = day.Exercises.Count(e => e.Status == "done");
                                    var dayProgress = dayTotal > 0 ? (decimal)dayCompleted / dayTotal * 100 : 0;
                                }
                                <MudProgressLinear Value="@((int)dayProgress)"
                                                   Color="Color.Success"
                                                   Class="progress-bar"
                                                   Size="Size.Small" />
                                <MudText Typo="Typo.caption" Class="progress-text">
                                    @dayCompleted/@dayTotal completed
                                </MudText>
                            </div>
                        }
                    </div>

                    <div class="exercises-container">
                        @if (day.Exercises.Any())
                        {
                            @foreach (var exercise in day.Exercises)
                            {
                                <div class="exercise-card @GetExerciseStatusClass(exercise.Status)">
                                    <div class="exercise-header">
                                        <MudText Typo="Typo.body1" Class="exercise-name">
                                            @exercise.ExerciseName
                                        </MudText>
                                        <div class="exercise-status">
                                            @if (exercise.Status == "planned")
                                            {
                                                <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Small" />
                                            }
                                            else if (exercise.Status == "done")
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                            }
                                            else if (exercise.Status == "partial")
                                            {
                                                <MudIcon Icon="@Icons.Material.Outlined.MoreHoriz" Size="Size.Small" Color="Color.Warning" />
                                            }
                                            else if (exercise.Status == "skipped")
                                            {
                                                <MudIcon Icon="@Icons.Material.Outlined.Close" Size="Size.Small" Color="Color.Secondary" />
                                            }
                                        </div>
                                    </div>

                                    @if (exercise.TargetSets.HasValue || exercise.TargetReps.HasValue)
                                    {
                                        <MudText Typo="Typo.caption" Class="exercise-targets">
                                            @if (exercise.TargetSets.HasValue)
                                            {
                                                <text>@exercise.TargetSets sets</text>
                                            }
                                            @if (exercise.TargetSets.HasValue && exercise.TargetReps.HasValue)
                                            {
                                                <text> × </text>
                                            }
                                            @if (exercise.TargetReps.HasValue)
                                            {
                                                <text>@exercise.TargetReps reps</text>
                                            }
                                            @if (exercise.HoldSeconds.HasValue)
                                            {
                                                <text> × @exercise.HoldSeconds sec</text>
                                            }
                                        </MudText>
                                    }

                                    @if (exercise.Status == "planned")
                                    {
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Filled"
                                                   Color="Color.Success"
                                                   OnClick="@(() => QuickLogComplete(exercise.ExerciseInstanceId))"
                                                   FullWidth="true"
                                                   Class="complete-button">
                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="mr-1" />
                                            Complete
                                        </MudButton>
                                    }

                                    @if (!string.IsNullOrEmpty(exercise.Notes))
                                    {
                                        <MudText Typo="Typo.caption" Class="exercise-notes">
                                            @exercise.Notes
                                        </MudText>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-day">
                                <MudIcon Icon="@Icons.Material.Outlined.FreeBreakfast" Size="Size.Medium" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2" Class="mt-2">Rest day</MudText>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        @if (board.Days.SelectMany(d => d.Exercises).Any())
        {
            <MudCard Class="mt-6">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">Weekly Summary</MudText>
                    @{
                        var totalExercises = board.Days.SelectMany(d => d.Exercises).Count();
                        var completedExercises = board.Days.SelectMany(d => d.Exercises).Count(e => e.Status == "done");
                        var percentage = totalExercises > 0 ? (decimal)completedExercises / totalExercises * 100 : 0;
                    }
                    <MudGrid>
                        <MudItem xs="4">
                            <MudText Typo="Typo.body1">Total Exercises: @totalExercises</MudText>
                        </MudItem>
                        <MudItem xs="4">
                            <MudText Typo="Typo.body1">Completed: @completedExercises</MudText>
                        </MudItem>
                        <MudItem xs="4">
                            <MudText Typo="Typo.body1">Progress: @percentage.ToString("F1")%</MudText>
                        </MudItem>
                    </MudGrid>
                    <MudProgressLinear Value="@((int)percentage)" Class="mt-2" />
                </MudCardContent>
            </MudCard>
        }
    }
    else
    {
        <MudCard>
            <MudCardContent Class="text-center py-8">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Class="mt-4">No active plans</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    You don't have any active exercise plans yet. Check your proposals!
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Href="/proposals"
                           Class="mt-4"
                           StartIcon="@Icons.Material.Filled.Inbox">
                    View Proposals
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>


@code {
    private DateOnly currentWeekStart = GetCurrentWeekStart();
    private BoardResponse? board;
    private bool isLoading = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthAndRedirect();
        await LoadBoard();
    }

    private async Task CheckAuthAndRedirect()
    {
        try
        {
            var response = await HttpClient.GetAsync("/auth/me");
            if (!response.IsSuccessStatusCode)
            {
                NavigationManager.NavigateTo("/auth/client/login");
                return;
            }

            var userInfo = await response.Content.ReadFromJsonAsync<JsonElement>();
            if (userInfo.GetProperty("userType").GetString() != "client")
            {
                NavigationManager.NavigateTo("/auth/client/login");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/auth/client/login");
        }
    }

    private async Task LoadBoard()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            var response = await HttpClient.GetAsync($"/api/client/board?weekStart={currentWeekStart:yyyy-MM-dd}");
            if (response.IsSuccessStatusCode)
            {
                board = await response.Content.ReadFromJsonAsync<BoardResponse>();
            }
            else
            {
                errorMessage = "Failed to load board.";
            }
        }
        catch (Exception)
        {
            errorMessage = "Network error while loading board.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PreviousWeek()
    {
        currentWeekStart = currentWeekStart.AddDays(-7);
        await LoadBoard();
    }

    private async Task NextWeek()
    {
        currentWeekStart = currentWeekStart.AddDays(7);
        await LoadBoard();
    }

    private async Task QuickLogComplete(int exerciseInstanceId)
    {
        try
        {
            var request = new { ExerciseInstanceId = exerciseInstanceId, Completed = true };
            var response = await HttpClient.PostAsJsonAsync("/api/client/board/quick-log", request);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Exercise marked as completed!", Severity.Success);
                await LoadBoard(); // Refresh the board
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to log progress: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Network error: {ex.Message}", Severity.Error);
        }
    }

    private static DateOnly GetCurrentWeekStart()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var dayOfWeek = (int)today.DayOfWeek;
        var daysToSubtract = dayOfWeek == 0 ? 6 : dayOfWeek - 1; // Sunday = 6 days back
        return today.AddDays(-daysToSubtract);
    }

    private string GetDayColumnClass(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        return date == today ? "is-today" : "";
    }

    private string GetExerciseStatusClass(string status)
    {
        return status switch
        {
            "done" => "is-completed",
            "partial" => "is-partial",
            "skipped" => "is-skipped",
            _ => "is-planned"
        };
    }

    public class BoardResponse
    {
        public DateOnly WeekStart { get; set; }
        public DateOnly WeekEnd { get; set; }
        public DayBoardResponse[] Days { get; set; } = Array.Empty<DayBoardResponse>();
    }

    public class DayBoardResponse
    {
        public string DayName { get; set; } = "";
        public DateOnly Date { get; set; }
        public int DayOfWeek { get; set; }
        public ExerciseCardResponse[] Exercises { get; set; } = Array.Empty<ExerciseCardResponse>();
    }

    public class ExerciseCardResponse
    {
        public int ExerciseInstanceId { get; set; }
        public string ExerciseName { get; set; } = "";
        public string? ExerciseDescription { get; set; }
        public int? TargetSets { get; set; }
        public int? TargetReps { get; set; }
        public int? HoldSeconds { get; set; }
        public string Status { get; set; } = "";
        public int? CompletedSets { get; set; }
        public int? CompletedReps { get; set; }
        public int? CompletedHoldSeconds { get; set; }
        public string? Notes { get; set; }
    }
}