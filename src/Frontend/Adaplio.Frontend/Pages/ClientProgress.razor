@page "/progress"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>My Progress - Adaplio</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">
            @errorMessage
        </MudAlert>
    }

    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" />
        My Progress & Adherence
    </MudText>

    <MudGrid>
        <!-- Log Progress Card -->
        <MudItem xs="12" lg="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
                            Log Exercise Progress
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (exerciseInstances.Any())
                    {
                        <MudForm @ref="progressForm">
                            <MudSelect @bind-Value="selectedExerciseId"
                                       Label="Select Exercise"
                                       Variant="Variant.Outlined"
                                       Class="mb-4">
                                @foreach (var exercise in exerciseInstances)
                                {
                                    <MudSelectItem T="int?" Value="@exercise.Id">
                                        @exercise.ExerciseName (@exercise.TargetSets sets, @exercise.TargetReps reps)
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            <MudSelect @bind-Value="logRequest.EventType"
                                       Label="Progress Type"
                                       Variant="Variant.Outlined"
                                       Class="mb-4">
                                <MudSelectItem T="string" Value="@ExerciseCompletedType">Exercise Completed</MudSelectItem>
                                <MudSelectItem T="string" Value="@SetCompletedType">Set Completed</MudSelectItem>
                            </MudSelect>

                            @if (logRequest.EventType == SetCompletedType || logRequest.EventType == ExerciseCompletedType)
                            {
                                <MudGrid>
                                    <MudItem xs="4">
                                        <MudNumericField @bind-Value="logRequest.SetsCompleted"
                                                         Label="Sets Completed"
                                                         Variant="Variant.Outlined"
                                                         Min="0" />
                                    </MudItem>
                                    <MudItem xs="4">
                                        <MudNumericField @bind-Value="logRequest.RepsCompleted"
                                                         Label="Reps Completed"
                                                         Variant="Variant.Outlined"
                                                         Min="0" />
                                    </MudItem>
                                    <MudItem xs="4">
                                        <MudNumericField @bind-Value="logRequest.HoldSecondsCompleted"
                                                         Label="Hold Seconds"
                                                         Variant="Variant.Outlined"
                                                         Min="0" />
                                    </MudItem>
                                </MudGrid>
                            }

                            <MudGrid Class="mt-4">
                                <MudItem xs="6">
                                    <MudSelect @bind-Value="logRequest.DifficultyRating"
                                               Label="Difficulty (1-10)"
                                               Variant="Variant.Outlined">
                                        @for (int i = 1; i <= 10; i++)
                                        {
                                            <MudSelectItem T="int?" Value="@i">@i</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudSelect @bind-Value="logRequest.PainLevel"
                                               Label="Pain Level (1-10)"
                                               Variant="Variant.Outlined">
                                        @for (int i = 1; i <= 10; i++)
                                        {
                                            <MudSelectItem T="int?" Value="@i">@i</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                            </MudGrid>

                            <MudTextField @bind-Value="logRequest.Notes"
                                          Label="Notes (optional)"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          Class="mt-4" />
                        </MudForm>
                    }
                    else if (isLoadingExercises)
                    {
                        <div class="d-flex justify-center pa-4">
                            <MudProgressCircular Indeterminate="true" />
                            <MudText Class="ml-3">Loading exercises...</MudText>
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="py-4">
                            No exercises found. Contact your trainer to get started!
                        </MudText>
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="LogProgress"
                               Disabled="@(isLoggingProgress || selectedExerciseId == null || string.IsNullOrEmpty(logRequest.EventType))"
                               StartIcon="@Icons.Material.Filled.Save">
                        @if (isLoggingProgress)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-3">Logging...</MudText>
                        }
                        else
                        {
                            <MudText>Log Progress</MudText>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <!-- Recent Progress -->
        <MudItem xs="12" lg="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                            Recent Activity
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Style="max-height: 400px; overflow-y: auto;">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="py-4">
                        Recent progress activity will be shown here
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Adherence Summary -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Analytics" Class="mr-2" />
                            My Adherence Summary
                        </MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                       Color="Color.Default"
                                       OnClick="LoadAdherenceSummary"
                                       Disabled="@isLoadingAdherence" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (isLoadingAdherence)
                    {
                        <div class="d-flex justify-center pa-4">
                            <MudProgressCircular Indeterminate="true" />
                            <MudText Class="ml-3">Loading adherence data...</MudText>
                        </div>
                    }
                    else if (adherenceSummary != null)
                    {
                        <MudGrid>
                            <MudItem xs="12" sm="4">
                                <MudCard Outlined="true">
                                    <MudCardContent Class="text-center">
                                        <MudText Typo="Typo.h4" Color="Color.Primary">
                                            @adherenceSummary.OverallAdherence.ToString("F1")%
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Overall Adherence</MudText>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudCard Outlined="true">
                                    <MudCardContent Class="text-center">
                                        <MudText Typo="Typo.h4" Color="Color.Info">
                                            @(adherenceSummary.WeeklyData.LastOrDefault()?.AdherencePercentage.ToString("F1") ?? "0")%
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">This Week</MudText>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudCard Outlined="true">
                                    <MudCardContent Class="text-center">
                                        <MudText Typo="Typo.h4" Color="Color.Success">
                                            @adherenceSummary.WeeklyData.Length
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Weeks Tracked</MudText>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="py-4">
                            No adherence data available yet. Start logging progress to see your statistics!
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private const string ExerciseCompletedType = "exercise_completed";
    private const string SetCompletedType = "set_completed";

    private List<ExerciseInfo> exerciseInstances = new();
    private AdherenceSummaryResponse? adherenceSummary;
    private MudForm? progressForm;

    private bool isLoadingExercises = false;
    private bool isLoadingAdherence = false;
    private bool isLoggingProgress = false;
    private string errorMessage = "";

    private int? selectedExerciseId;
    private LogProgressRequest logRequest = new()
    {
        EventType = ExerciseCompletedType
    };

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthAndRedirect();
        await LoadExercises();
        await LoadAdherenceSummary();
    }

    private async Task CheckAuthAndRedirect()
    {
        try
        {
            var response = await HttpClient.GetAsync("/auth/me");
            if (!response.IsSuccessStatusCode)
            {
                NavigationManager.NavigateTo("/auth/client/login");
                return;
            }

            var userInfo = await response.Content.ReadFromJsonAsync<JsonElement>();
            if (userInfo.GetProperty("userType").GetString() != "client")
            {
                NavigationManager.NavigateTo("/auth/client/login");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/auth/client/login");
        }
    }

    private async Task LoadExercises()
    {
        isLoadingExercises = true;
        errorMessage = "";

        try
        {
            // For now, create mock exercise instances since we don't have plan/exercise management yet
            exerciseInstances = new List<ExerciseInfo>
            {
                new() { Id = 1, ExerciseName = "Wall Push-ups", TargetSets = 3, TargetReps = 10 },
                new() { Id = 2, ExerciseName = "Shoulder Rolls", TargetSets = 2, TargetReps = 15 },
                new() { Id = 3, ExerciseName = "Neck Stretches", TargetSets = 1, TargetReps = 5 }
            };
        }
        catch (Exception)
        {
            errorMessage = "Failed to load exercises.";
        }
        finally
        {
            isLoadingExercises = false;
        }
    }

    private async Task LoadAdherenceSummary()
    {
        isLoadingAdherence = true;

        try
        {
            var response = await HttpClient.GetAsync("/api/client/progress/summary");
            if (response.IsSuccessStatusCode)
            {
                adherenceSummary = await response.Content.ReadFromJsonAsync<AdherenceSummaryResponse>();
            }
        }
        catch (Exception)
        {
            // Silently fail for adherence summary
        }
        finally
        {
            isLoadingAdherence = false;
        }
    }

    private async Task LogProgress()
    {
        if (selectedExerciseId == null) return;

        isLoggingProgress = true;
        errorMessage = "";

        try
        {
            logRequest.ExerciseInstanceId = selectedExerciseId.Value;

            var response = await HttpClient.PostAsJsonAsync("/api/client/progress", logRequest);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Progress logged successfully!", Severity.Success);

                // Reset form
                selectedExerciseId = null;
                logRequest = new LogProgressRequest { EventType = ExerciseCompletedType };

                // Refresh adherence summary
                await LoadAdherenceSummary();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to log progress: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Network error: {ex.Message}";
        }
        finally
        {
            isLoggingProgress = false;
        }
    }

    public class ExerciseInfo
    {
        public int Id { get; set; }
        public string ExerciseName { get; set; } = "";
        public int? TargetSets { get; set; }
        public int? TargetReps { get; set; }
    }

    public class LogProgressRequest
    {
        public int ExerciseInstanceId { get; set; }
        public string EventType { get; set; } = "";
        public int? SetsCompleted { get; set; }
        public int? RepsCompleted { get; set; }
        public int? HoldSecondsCompleted { get; set; }
        public int? DifficultyRating { get; set; }
        public int? PainLevel { get; set; }
        public string? Notes { get; set; }
    }

    public class WeeklyAdherence
    {
        public int Year { get; set; }
        public int WeekNumber { get; set; }
        public DateOnly WeekStartDate { get; set; }
        public decimal AdherencePercentage { get; set; }
        public int CompletedCount { get; set; }
        public int PlannedCount { get; set; }
    }

    public class AdherenceSummaryResponse
    {
        public string ClientAlias { get; set; } = "";
        public WeeklyAdherence[] WeeklyData { get; set; } = Array.Empty<WeeklyAdherence>();
        public decimal OverallAdherence { get; set; }
    }
}