@page "/home/trainer"
@using Adaplio.Frontend.Services
@using Adaplio.Frontend.Components.Trainer
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>Clients Overview - Adaplio</PageTitle>

<RoleGate TrainerOnly="true">

<div class="trainer-home-modern">
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-8">
        <!-- Modern Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="modern-header">Clients Overview</h1>
                <p class="modern-subheader">
                    Welcome back, @AuthState.FullName â€” @GetClientSummary()
                </p>
            </div>

            <div class="header-actions">
                <div class="filter-tabs">
                    <button class="filter-tab @(_currentFilter == "all" ? "active" : "")"
                            @onclick="@(() => SetFilter("all"))">
                        All (@_clients.Count)
                    </button>
                    <button class="filter-tab @(_currentFilter == "summary" ? "active" : "")"
                            @onclick="@(() => SetFilter("summary"))">
                        Summary (@_clients.Count(c => c.SharesSummary))
                    </button>
                    <button class="filter-tab @(_currentFilter == "private" ? "active" : "")"
                            @onclick="@(() => SetFilter("private"))">
                        Private (@_clients.Count(c => !c.SharesSummary))
                    </button>
                </div>

                <!-- Top-right Icons for Notifications -->
                <div class="top-actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Notifications"
                                   Class="notification-icon"
                                   OnClick="ToggleNotifications">
                        @if (_notifications.Any(n => !n.IsRead))
                        {
                            <MudBadge Content="@_notifications.Count(n => !n.IsRead)"
                                      Color="Color.Error"
                                      Overlap="true"
                                      Class="notification-badge" />
                        }
                    </MudIconButton>
                </div>
            </div>
        </div>

        <!-- Main Client Cards Section -->
        <div class="clients-section">
            @if (_isLoading)
            {
                <div class="loading-cards">
                    @for (int i = 0; i < 5; i++)
                    {
                        <div class="client-card loading">
                            <MudSkeleton Height="180px" />
                        </div>
                    }
                </div>
            }
            else if (!_filteredClients.Any())
            {
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <MudIcon Icon="@Icons.Material.Outlined.PersonSearch" Size="Size.Large" />
                    </div>
                    <div class="empty-state-title">No clients yet</div>
                    <div class="empty-state-description">
                        Start building your client base by sending your first invite.
                        Once clients accept, they'll appear here as beautiful cards.
                    </div>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="SendInvite"
                               Class="empty-state-action">
                        Send First Invite
                    </MudButton>
                </div>
            }
            else
            {
                <div class="client-cards-grid">
                    @foreach (var client in _filteredClients)
                    {
                        <ClientCard ClientData="@client"
                                    OnViewDetails="@ViewClientDetails"
                                    OnSendProposal="@SendProposal"
                                    OnManageClient="@ManageClient" />
                    }
                </div>
            }
        </div>
    </MudContainer>

    <!-- Notification Slide Panel -->
    <NotificationPanel IsOpen="@_notificationPanelOpen"
                       Notifications="@_convertedNotifications"
                       IsOpenChanged="@OnNotificationPanelToggle"
                       OnNotificationRead="@OnNotificationRead"
                       OnMarkAllRead="@OnMarkAllNotificationsRead" />

    <!-- Floating Action Button -->
    <FloatingActionButton OnNewProposal="@OnNewProposal"
                           OnUploadVideo="@OnUploadVideo"
                           OnSendInvite="@SendInvite" />
</div>

<style>
/* 2025 Minimal SaaS Trainer Home */
.trainer-home-modern {
    background: var(--color-background);
    min-height: 100vh;
    font-family: var(--font-family-primary);
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-xxxxl);
    gap: var(--space-xl);
}

.header-content {
    flex: 1;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-xl);
}

.filter-tabs {
    display: flex;
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-xs);
    box-shadow: var(--elevation-2);
    gap: var(--space-xs);
}

.filter-tab {
    background: transparent;
    border: none;
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-neutral-700);
    cursor: pointer;
    transition: all var(--duration-fast) var(--easing-standard);
    white-space: nowrap;
}

.filter-tab:hover {
    background: var(--color-neutral-100);
    color: var(--color-neutral-900);
}

.filter-tab.active {
    background: var(--color-primary);
    color: var(--color-primary-on);
    box-shadow: var(--elevation-1);
}

.top-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.notification-icon {
    padding: var(--space-md);
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    box-shadow: var(--elevation-2);
    color: var(--color-neutral-700);
    transition: all var(--duration-fast) var(--easing-standard);
}

.notification-icon:hover {
    background: var(--color-neutral-100);
    transform: translateY(-1px);
    box-shadow: var(--elevation-3);
}

.clients-section {
    width: 100%;
}

.client-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--space-xl);
    width: 100%;
}

.loading-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--space-xl);
}

.loading-cards .client-card.loading {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    box-shadow: var(--elevation-2);
}

.empty-state-action {
    margin-top: var(--space-lg);
}

</style>

@code {
    private bool _isLoading = true;
    private string _currentFilter = "all";
    private bool _notificationPanelOpen = false;
    private List<ClientData> _clients = new();
    private List<Notification> _notifications = new();

    private IEnumerable<ClientData> _filteredClients => _currentFilter switch
    {
        "summary" => _clients.Where(c => c.SharesSummary),
        "private" => _clients.Where(c => !c.SharesSummary),
        _ => _clients
    };

    private List<Components.Trainer.NotificationPanel.Notification> _convertedNotifications =>
        _notifications.Select(n => new Components.Trainer.NotificationPanel.Notification
        {
            Message = n.Message,
            CreatedAt = n.CreatedAt,
            IsRead = n.IsRead
        }).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        StateHasChanged();

        // Simulate API delay
        await Task.Delay(1000);

        // Mock data - Enhanced for 2025 design
        _clients = new List<ClientData>
        {
            new() { Id = 1, Alias = "C-AB12", DisplayName = "Sarah's Recovery Journey", Email = "sarah.j@email.com", SharesSummary = true, AdherencePercent = 85, LastActivity = DateTime.Now.AddHours(-2) },
            new() { Id = 2, Alias = "C-CD34", DisplayName = "Mike's Strength Training", Email = "mike.r@email.com", SharesSummary = false, AdherencePercent = 92, LastActivity = DateTime.Now.AddDays(-1) },
            new() { Id = 3, Alias = "C-EF56", DisplayName = "Getting Stronger ðŸ’ª", Email = "alex.m@email.com", SharesSummary = true, AdherencePercent = 67, LastActivity = DateTime.Now.AddDays(-3) },
            new() { Id = 4, Alias = "C-GH78", DisplayName = null, Email = "client4@email.com", SharesSummary = true, AdherencePercent = 94, LastActivity = DateTime.Now.AddHours(-4) },
            new() { Id = 5, Alias = "C-IJ90", DisplayName = "Recovery Plus", Email = "jamie.l@email.com", SharesSummary = false, AdherencePercent = 78, LastActivity = DateTime.Now.AddDays(-2) }
        };

        _notifications = new List<Notification>
        {
            new() { Message = "C-AB12 declined Hip Extension exercise", CreatedAt = DateTime.Now.AddMinutes(-30), IsRead = false },
            new() { Message = "C-CD34 changed sharing scope to Private", CreatedAt = DateTime.Now.AddHours(-2), IsRead = false },
            new() { Message = "C-EF56 completed Week 1 milestone", CreatedAt = DateTime.Now.AddDays(-1), IsRead = true }
        };

        _isLoading = false;
        StateHasChanged();
    }

    private void SetFilter(string filter)
    {
        _currentFilter = filter;
        StateHasChanged();
    }

    private async Task SendInvite()
    {
        // Generate grant code and copy to clipboard
        var grantCode = "GRANT-" + Guid.NewGuid().ToString("N")[..8].ToUpper();

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", grantCode);
            Snackbar.Add($"Grant code {grantCode} copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add($"Grant code: {grantCode} (Please copy manually)", Severity.Info);
        }
    }

    private void ViewSummary(int clientId)
    {
        Navigation.NavigateTo($"/clients/{clientId}/summary");
    }

    private void NewProposal(int clientId)
    {
        Navigation.NavigateTo($"/proposals/new?clientId={clientId}");
    }

    private async Task UploadVideo()
    {
        Navigation.NavigateTo("/media/upload");
    }

    // New 2025 functionality
    private string GetClientSummary()
    {
        if (!_clients.Any()) return "No clients connected yet";

        var activeToday = _clients.Count(c => c.LastActivity.Date == DateTime.Today);
        var avgAdherence = _clients.Average(c => c.AdherencePercent);

        return $"{_clients.Count} client{(_clients.Count == 1 ? "" : "s")}, {avgAdherence:F0}% avg adherence";
    }

    private void ToggleNotifications()
    {
        _notificationPanelOpen = !_notificationPanelOpen;
    }

    private async Task OnNotificationPanelToggle(bool isOpen)
    {
        _notificationPanelOpen = isOpen;
    }

    private async Task OnNotificationRead(Components.Trainer.NotificationPanel.Notification notification)
    {
        // Handle individual notification read
        StateHasChanged();
    }

    private async Task OnMarkAllNotificationsRead()
    {
        // Handle mark all notifications as read
        StateHasChanged();
    }

    private async Task ViewClientDetails(ClientData client)
    {
        if (client.SharesSummary)
        {
            Navigation.NavigateTo($"/clients/{client.Id}/summary");
        }
        else
        {
            Snackbar.Add("Client hasn't shared summary access", Severity.Info);
        }
    }

    private async Task SendProposal(ClientData client)
    {
        Navigation.NavigateTo($"/proposals/new?clientId={client.Id}");
    }

    private async Task ManageClient(ClientData client)
    {
        Navigation.NavigateTo($"/clients/{client.Id}/manage");
    }

    // FAB Actions
    private async Task OnNewProposal()
    {
        Navigation.NavigateTo("/proposals/new");
    }

    private async Task OnUploadVideo()
    {
        Navigation.NavigateTo("/media/upload");
    }

    private Color GetAdherenceColor(int percentage)
    {
        return percentage >= 80 ? Color.Success :
               percentage >= 60 ? Color.Warning :
               Color.Error;
    }


    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        return timeSpan.TotalMinutes < 60 ? $"{(int)timeSpan.TotalMinutes}m ago" :
               timeSpan.TotalHours < 24 ? $"{(int)timeSpan.TotalHours}h ago" :
               timeSpan.TotalDays < 7 ? $"{(int)timeSpan.TotalDays}d ago" :
               dateTime.ToString("MMM dd");
    }


    private string GetClientDisplayName(ClientData client)
    {
        if (!string.IsNullOrWhiteSpace(client.DisplayName))
        {
            return $"{client.DisplayName} ({client.Alias})";
        }
        return client.Alias;
    }

    // Data models
    public class ClientData
    {
        public int Id { get; set; }
        public string Alias { get; set; } = "";
        public string? DisplayName { get; set; }
        public string Email { get; set; } = "";
        public bool SharesSummary { get; set; }
        public int AdherencePercent { get; set; }
        public DateTime LastActivity { get; set; }
    }

    public class Notification
    {
        public string Message { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public bool IsRead { get; set; }
    }
}

</RoleGate>